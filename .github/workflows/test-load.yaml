name: Test Load Triggers CI/CD (Optimized)
on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker image name (e.g., rahat-project-triggers)'
        required: true
        default: 'rahat-project-triggers'
        type: string
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: true
        default: 'apps/triggers/Dockerfile.triggers'
        type: string
      tag_prefix:
        description: 'Tag prefix (e.g., test-load)'
        required: true
        default: 'test-load'
        type: string

env:
  CI: false
  PNPM_VERSION: '8.14.1'
  NODE_VERSION: '20.10.0'

jobs:
  deploy:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get short SHA and Run ID
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "run_id_short=${GITHUB_RUN_ID:0:3}" >> $GITHUB_OUTPUT
          echo "image_tag=${{ inputs.tag_prefix }}-$(git rev-parse --short HEAD)-${GITHUB_RUN_ID:0:3}" >> $GITHUB_OUTPUT

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js with caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile --prefer-offline

      - name: Generate database and build
        run: |
          pnpm --filter @lib/database db:generate
          pnpm turbo build --filter=triggers

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: rexxx9865
          password: dckr_pat_hSI1LAzMcEr0kSDkLCQyPfQaZD0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Build and Push Docker Image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ inputs.dockerfile_path }}
          push: true
          tags: |
            rexxx9865/${{ inputs.image_name }}:${{ inputs.tag_prefix }}
            rexxx9865/${{ inputs.image_name }}:${{ steps.vars.outputs.image_tag }}
          cache-from: |
            type=registry,ref=rexxx9865/${{ inputs.image_name }}:${{ inputs.tag_prefix }}
            type=registry,ref=rexxx9865/${{ inputs.image_name }}:buildcache
          cache-to: type=registry,ref=rexxx9865/${{ inputs.image_name }}:buildcache,mode=max
          provenance: false
          sbom: false

      - name: Output build information
        run: |
          echo "Image Digest: ${{ steps.build-push.outputs.digest }}"
          echo "Image Tag: rexxx9865/${{ inputs.image_name }}:${{ steps.vars.outputs.image_tag }}"

    outputs:
      sha_short: ${{ steps.vars.outputs.sha_short }}
      run_id_short: ${{ steps.vars.outputs.run_id_short }}
      image_tag: rexxx9865/${{ inputs.image_name }}:${{ steps.vars.outputs.image_tag }}
      image_digest: ${{ steps.build-push.outputs.digest }}
